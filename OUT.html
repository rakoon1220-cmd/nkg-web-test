<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì¶œê³ </title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!--  ìº¡ì²˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    body { background: #eef1f5; }

    @keyframes fadeIn {
      from { opacity:0; transform:translateY(20px) scale(0.95); }
      to   { opacity:1; transform:translateY(0) scale(1); }
    }
    .animate-fadeIn { animation: fadeIn 0.25s ease-out; }

    /* ===== ìµœê·¼ ìŠ¤ìº” 3ì¤„ ê³ ì • ===== */
    #scanList { max-height: 4.5rem; overflow: hidden; }

    /* ===== ìì¬ë²ˆí˜¸ ì—´ ìˆ¨ê¹€ (2ë²ˆì§¸ ì»¬ëŸ¼ = ìì¬ë²ˆí˜¸) ===== */
    th:nth-child(2), td:nth-child(2) { display: none; }
  </style>
</head>

<body class="min-h-screen bg-slate-100">

  <!-- NAV -->
  <script src="nav.js"></script>

  <div class="h-14"></div>
  <script>
    mobileNavBtn.onclick = () => mobileNavMenu.classList.toggle("hidden");
  </script>

  <!-- â–£ MAIN -->
  <main class="max-w-[1500px] mx-auto p-3 space-y-3 min-h-[calc(100dvh-56px)] flex flex-col">

    <!-- ================= ìƒë‹¨ ================= -->
    <section class="bg-white rounded-xl border p-3 space-y-4">

      <!-- ì¸ë³´ì´ìŠ¤ + ë²„íŠ¼ -->
      <div class="grid grid-cols-1 gap-2">

        <input id="invInput"
          class="w-full px-4 py-4 text-2xl font-extrabold tracking-[0.12em]
                 border-2 border-slate-600 rounded-2xl
                 focus:ring-4 focus:ring-sky-500 text-center bg-slate-50"
          placeholder="INV NO"
          autocomplete="off"
          inputmode="numeric" />

        <!--  ì¡°íšŒ | íŠ¹ì´ì‚¬í•­ | ì €ì¥ -->
        <div class="grid grid-cols-3 divide-x divide-white rounded-2xl overflow-hidden shadow-sm">
          <button id="btnLoadInv"
            class="py-3 text-base font-extrabold bg-sky-600 hover:bg-sky-700 text-white">
            ì¡°íšŒ
          </button>
          <button id="btnNoticeOpen"
            class="py-3 text-base font-extrabold bg-orange-500 hover:bg-orange-600 text-white">
            íŠ¹ì´ì‚¬í•­
          </button>
          <button id="btnCapture"
            class="py-3 text-base font-extrabold bg-emerald-600 hover:bg-emerald-700 text-white">
            ì €ì¥
          </button>
        </div>
      </div>

      <!--  ìš”ì•½ -->
      <div class="bg-slate-50 border rounded-xl p-3 space-y-2 text-sm">
        <div class="grid grid-cols-2 gap-2">
          <div><div class="text-[11px] text-slate-500">ì¸ë³´ì´ìŠ¤</div><div id="inv_no">-</div></div>
          <div><div class="text-[11px] text-slate-500">êµ­ê°€</div><div id="country">-</div></div>
          <div><div class="text-[11px] text-slate-500">ìƒì°¨ìœ„ì¹˜</div><div id="load_loc">-</div></div>
          <div><div class="text-[11px] text-slate-500">ìƒì°¨ì‹œê°„</div><div id="load_time">-</div></div>
        </div>
        <div class="grid grid-cols-3 gap-2">
          <div><div class="text-[11px] text-slate-500">ì»¨í…Œì´ë„ˆ</div><div id="container">-</div></div>
          <div><div class="text-[11px] text-slate-500">CBM</div><div id="cbm">-</div></div>
          <div><div class="text-[11px] text-slate-500">ìˆ˜ëŸ‰</div><div id="qty">-</div></div>
        </div>
      </div>

      <!-- ë°”ì½”ë“œ ì…ë ¥ -->
      <input id="barcodeInput"
        class="w-full px-4 py-4 text-lg border rounded-xl"
        placeholder="ë°”ì½”ë“œë¥¼ ìŠ¤ìº”í•˜ì„¸ìš”" autofocus />

      <!-- scan.jsìš© DOM ìœ ì§€ (ìˆ¨ê¹€) -->
      <div class="hidden">
        <div id="recentScanStatus"></div>
        <div id="recentScanDetail"></div>
        <span id="progress_now"></span>
        <span id="progress_total"></span>
        <span id="progress_percent"></span>
        <div id="progress_bar"></div>
        <span id="error_count"></span>
        <span id="dup_count"></span>
      </div>
    </section>

    <!-- ================= í•˜ë‹¨ ================= -->
    <section class="flex flex-col gap-3 flex-1">

      <!--  ìµœê·¼ ìŠ¤ìº” -->
      <div class="bg-white rounded-xl border p-3">
        <div class="text-xs text-slate-500 mb-2">ìŠ¤ìº”ëœ ëª©ë¡ (ìµœê·¼ 3ê±´)</div>
        <div id="scanList" class="text-sm leading-6 text-slate-700">
          <div class="text-slate-400">ì•„ì§ ìŠ¤ìº” ì—†ìŒâ€¦</div>
        </div>
      </div>

      <!--  ìº¡ì²˜í•  ì˜ì—­ -->
      <div id="captureArea" class="space-y-3 flex-1">
        <div class="bg-white rounded-xl border flex flex-col flex-1">
          <div class="px-3 py-2 border-b text-xs text-slate-500 flex justify-between">
            <span>ì¶œê³ /ì „ì²´ ëª©ë¡</span>
            <span class="text-slate-400">ê°€ë¡œ ìŠ¤í¬ë¡¤</span>
          </div>
          <div class="flex-1 overflow-auto">
            <table class="min-w-[980px] text-[12px]">
              <thead class="bg-slate-50 sticky top-0">
                <tr>
                  <th class="px-3 py-2">ë²ˆí˜¸</th>
                  <th class="px-3 py-2">ìì¬ë²ˆí˜¸</th>
                  <th class="px-3 py-2">ë°•ìŠ¤ë²ˆí˜¸</th>
                  <th class="px-3 py-2">ìì¬ë‚´ì—­</th>
                  <th class="px-3 py-2 text-right">SAP</th>
                  <th class="px-3 py-2 text-right">WMS</th>
                  <th class="px-3 py-2 text-right">ë¹„êµ</th>
                  <th class="px-3 py-2">ì‘ì—…</th>
                  <th class="px-3 py-2">ë°”ì½”ë“œ</th>
                  <th class="px-3 py-2">ìƒíƒœ</th>
                </tr>
              </thead>
              <tbody id="scanTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

    </section>
  </main>

  <!-- ===== íŠ¹ì´ì‚¬í•­ ëª¨ë‹¬ ===== -->
  <div id="noticeModal"
       class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-2xl p-6 w-[90%] max-w-md animate-fadeIn">
      <h2 class="text-lg font-bold text-red-600 mb-3 text-center">âš  íŠ¹ì´ì‚¬í•­</h2>
      <div id="noticeText" class="text-sm text-center whitespace-pre-line"></div>
      <button id="noticeCloseBtn"
        class="mt-5 w-full py-3 bg-sky-600 text-white rounded-xl">
        í™•ì¸
      </button>
    </div>
  </div>

  <!-- =====  ë¯¸ë“±ë¡ ë°”ì½”ë“œ í™•ì¸ ëª¨ë‹¬ ===== -->
  <div id="unregModal"
       class="fixed inset-0 bg-black/60 hidden flex items-center justify-center z-[9999]">
    <div class="bg-white rounded-2xl p-6 w-[92%] max-w-md animate-fadeIn">

      <h2 class="text-lg font-bold text-red-600 mb-4 text-center">
         ë¯¸ë“±ë¡ ë°”ì½”ë“œ
      </h2>

      <div class="bg-slate-50 border rounded-xl p-4 text-sm text-center space-y-2">
        <div class="text-slate-500 text-xs">ìŠ¤ìº”ëœ ë°”ì½”ë“œ</div>
        <div id="unregCode" class="text-base font-extrabold text-slate-900 break-all">-</div>
        <div class="text-slate-600 text-xs leading-relaxed">
          ì¶œê³  ëª©ë¡ì— ë“±ë¡ë˜ì§€ ì•Šì€ ë°”ì½”ë“œì…ë‹ˆë‹¤.<br>
          ë‚´ìš©ì„ í™•ì¸ í›„ ì²´í¬í•´ì•¼ ê³„ì† ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        </div>
      </div>

      <label class="mt-4 flex items-center gap-2 text-sm font-semibold">
        <input id="unregCheck" type="checkbox" class="w-4 h-4 accent-sky-600">
        ë¯¸ë“±ë¡ ë‚´ìš©ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤.
      </label>

      <button id="unregConfirmBtn" disabled
        class="mt-5 w-full py-3 rounded-xl font-bold
               bg-slate-300 text-slate-600 cursor-not-allowed">
        í™•ì¸ í›„ ê³„ì†
      </button>
    </div>
  </div>

  <!-- =========================
        scan.js (ì´ í˜ì´ì§€ ì „ìš©, ì¸ë¼ì¸ ì „ì²´)
  ========================= -->
  <script>
  /* ============================================================
     ì¶œê³ /ì „ì²´ë³´ê¸° - ìŠ¤ìº” + ë¯¸ë“±ë¡ ëª¨ë‹¬ ì ê¸ˆ í¬í•¨
  ============================================================ */

  const IS_FILE = location.protocol === "file:";
  const API_BASE = window.location.origin;

  /* ===== DOM ===== */
  const invInput = document.getElementById("invInput");
  const btnLoadInv = document.getElementById("btnLoadInv");
  const btnNoticeOpen = document.getElementById("btnNoticeOpen");

  const inv_no = document.getElementById("inv_no");
  const country = document.getElementById("country");
  const containerEl = document.getElementById("container");
  const cbm = document.getElementById("cbm");
  const qty = document.getElementById("qty");
  const load_time = document.getElementById("load_time");
  const load_loc = document.getElementById("load_loc");

  const barcodeInput = document.getElementById("barcodeInput");
  const scanList = document.getElementById("scanList");
  const scanTableBody = document.getElementById("scanTableBody");

  // (ìˆ¨ê¹€ DOM)
  const recentScanStatus = document.getElementById("recentScanStatus");
  const recentScanDetail = document.getElementById("recentScanDetail");
  const progress_now = document.getElementById("progress_now");
  const progress_total = document.getElementById("progress_total");
  const progress_percent = document.getElementById("progress_percent");
  const progress_bar = document.getElementById("progress_bar");
  const error_count = document.getElementById("error_count");
  const dup_count = document.getElementById("dup_count");

  /* ===== ëª¨ë‹¬ ===== */
  const noticeModal = document.getElementById("noticeModal");
  const noticeText = document.getElementById("noticeText");
  const noticeCloseBtn = document.getElementById("noticeCloseBtn");

  /* ===== ë¯¸ë“±ë¡ ëª¨ë‹¬ ===== */
  const unregModal = document.getElementById("unregModal");
  const unregCode = document.getElementById("unregCode");
  const unregCheck = document.getElementById("unregCheck");
  const unregConfirmBtn = document.getElementById("unregConfirmBtn");

  /* ===== ì‚¬ìš´ë“œ(ì„ íƒ) ===== */
  let soundOk, soundDup, soundError, soundModal;
  if (!IS_FILE) {
    soundOk = new Audio("/sound/ok.mp3");
    soundDup = new Audio("/sound/dup.mp3");
    soundError = new Audio("/sound/error.mp3");
    soundModal = new Audio("/sound/modal.mp3");
  }
  function playSound(a) {
    if (!a) return;
    a.currentTime = 0;
    a.play().catch(() => {});
  }

  /* ===== ìƒíƒœ ===== */
  let currentNotice = "";
  let outboundItems = [];
  let scanHistory = [];
  let scannedCodesSet = new Set();
  let dupCountValue = 0;
  let errorCountValue = 0;
  let lastScannedBarcode = null;

  // ë°”ì½”ë“œ í‘œ(ë¯¸ë“±ë¡ ìƒì„¸)
  let barcodeIndexByCode = {};

  /* ===== ìŠ¤ìº” ì ê¸ˆ ===== */
  let scanLocked = false;

  function setScanLocked(lock) {
    scanLocked = lock;
    barcodeInput.disabled = lock;
    if (lock) barcodeInput.blur();
    else setTimeout(() => barcodeInput.focus(), 50);
  }

  function openUnregModal(code, meta) {
    playSound(soundModal);

    let text = code || "-";
    if (meta) {
      if (meta.box) text += ` / ë°•ìŠ¤:${meta.box}`;
      if (meta.name) text += ` / ${meta.name}`;
    } else {
      text += " / (ë°”ì½”ë“œí‘œ ì—†ìŒ)";
    }
    unregCode.textContent = text;

    unregCheck.checked = false;
    unregConfirmBtn.disabled = true;
    unregConfirmBtn.className =
      "mt-5 w-full py-3 rounded-xl font-bold bg-slate-300 text-slate-600 cursor-not-allowed";

    unregModal.classList.remove("hidden");
    setScanLocked(true);

    unregCheck.onchange = () => {
      if (unregCheck.checked) {
        unregConfirmBtn.disabled = false;
        unregConfirmBtn.className =
          "mt-5 w-full py-3 rounded-xl font-bold bg-sky-600 hover:bg-sky-700 text-white";
      } else {
        unregConfirmBtn.disabled = true;
        unregConfirmBtn.className =
          "mt-5 w-full py-3 rounded-xl font-bold bg-slate-300 text-slate-600 cursor-not-allowed";
      }
    };

    unregConfirmBtn.onclick = () => {
      if (unregConfirmBtn.disabled) return;
      unregModal.classList.add("hidden");
      setScanLocked(false);
      barcodeInput.value = "";
    };
  }

  /* ------------------------------------------------------------
     ë°”ì½”ë“œ ì „ì²´ í‘œ ë¡œë“œ
  ------------------------------------------------------------ */
  async function loadBarcodeTable() {
    if (IS_FILE) return;
    try {
      const res = await fetch(`${API_BASE}/api/barcode_table`);
      const json = await res.json();
      if (!json.ok) return;

      barcodeIndexByCode = {};
      json.list.forEach(r => {
        if (!r.barcode) return;
        barcodeIndexByCode[r.barcode] = { mat: r.mat, box: r.box, name: r.name };
      });
    } catch (err) {
      console.error("BARCODE LOAD ERROR:", err);
    }
  }

  /* ------------------------------------------------------------
     ì¸ë³´ì´ìŠ¤ ë¡œë“œ + ëª©ë¡
  ------------------------------------------------------------ */
  async function loadInvoice() {
    const inv = invInput.value.trim();
    if (!inv) return alert("ì¸ë³´ì´ìŠ¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");

    resetUI();

    try {
      const resDoc = await fetch(`${API_BASE}/api/sap_doc?inv=${encodeURIComponent(inv)}`);
      const jsonDoc = await resDoc.json();
      if (!jsonDoc.ok) return alert(jsonDoc.message || "ì¸ë³´ì´ìŠ¤ ì¡°íšŒ ì‹¤íŒ¨");

      const row = jsonDoc.data;

      inv_no.textContent = row["ì¸ë³´ì´ìŠ¤"] || "-";
      country.textContent = row["êµ­ê°€"] || "-";
      containerEl.textContent = row["ì»¨í…Œì´ë„ˆ"] || "-";
      cbm.textContent = row["CBM"] || "-";
      qty.textContent = row["ì¶œê³ "] || "-";
      load_time.textContent = row["ìƒì°¨ì‹œê°„"] || "-";
      load_loc.textContent = row["ìƒì°¨ìœ„ì¹˜"] || "-";

      if (row["íŠ¹ì´ì‚¬í•­"]?.trim()) {
        currentNotice = row["íŠ¹ì´ì‚¬í•­"];
        noticeText.textContent = currentNotice;
        noticeModal.classList.remove("hidden");
        playSound(soundModal);
      }

      const resItems = await fetch(`${API_BASE}/api/outbound_items?inv=${encodeURIComponent(inv)}`);
      const jsonItems = await resItems.json();
      if (!jsonItems.ok) return alert(jsonItems.message || "ì¶œê³  ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");

      outboundItems = jsonItems.items.map(it => ({ ...it, status: "ê²€ìˆ˜ëŒ€ê¸°", dup: false }));

      renderOutboundTable();
      updateProgress();
      barcodeInput.focus();
    } catch (err) {
      console.error(err);
      alert("ì„œë²„ ì˜¤ë¥˜ ë˜ëŠ” ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜");
    }
  }

  btnLoadInv.addEventListener("click", loadInvoice);
  invInput.addEventListener("keydown", e => { if (e.key === "Enter") loadInvoice(); });

  /* ------------------------------------------------------------
     compare í‘œì‹œ
  ------------------------------------------------------------ */
  function renderCompare(item) {
    const sap = Number(item.sap);
    const compare = Number(item.compare);

    if (sap === 0) return `<span></span>`;
    if (compare === 0) return `<span class="text-green-600 font-semibold">ì…ê³ ì™„ë£Œ</span>`;
    if (compare === sap) return `<span class="text-blue-600 font-semibold">ë¯¸ì…ê³ </span>`;
    if (compare < 0) return `<span class="text-blue-600 font-semibold">ì´ˆê³¼ì…ê³ </span>`;
    if (compare > 0 && compare < sap) {
      return `<span class="text-red-600 font-semibold">${compare} (ë¶€ë¶„ë¯¸ì…ê³ )</span>`;
    }
    return `<span>${compare}</span>`;
  }

  /* ------------------------------------------------------------
     í…Œì´ë¸” ë Œë”
  ------------------------------------------------------------ */
  function renderOutboundTable() {
    scanTableBody.innerHTML = "";

    outboundItems.forEach(item => {
      const tr = document.createElement("tr");
      let cls = "";

      if (Number(item.sap) === 0) cls += " bg-red-100 ";
      if (Number(item.compare) < 0) cls += " bg-blue-50 ";
      if (item.status === "ê²€ìˆ˜ì™„ë£Œ") cls += " bg-green-200 text-green-900 font-semibold ";
      if (item.dup) cls += " bg-yellow-100 ";
      if (item.barcode === lastScannedBarcode) cls += " ring-2 ring-amber-400 ";

      tr.className = cls.trim();

      const barcodeDisplay = item.barcode
        ? item.barcode
        : `<span class="text-red-600 font-semibold">ë°”ì½”ë“œë¯¸ë“±ë¡</span>`;

      const workDisplay = (item.work || "").toString().trim() || "-";

      tr.innerHTML = `
        <td class="px-3 py-2 whitespace-nowrap">${item.no}</td>
        <td class="px-3 py-2 whitespace-nowrap">${item.mat}</td>
        <td class="px-3 py-2 whitespace-nowrap">${item.box}</td>
        <td class="px-3 py-2 whitespace-nowrap">${item.name}</td>

        <td class="px-3 py-2 text-right whitespace-nowrap">${item.sap}</td>
        <td class="px-3 py-2 text-right whitespace-nowrap">${item.wms}</td>

        <td class="px-3 py-2 text-right whitespace-nowrap">${renderCompare(item)}</td>
        <td class="px-3 py-2 whitespace-nowrap">${workDisplay}</td>
        <td class="px-3 py-2 whitespace-nowrap">${barcodeDisplay}</td>
        <td class="px-3 py-2 whitespace-nowrap">${item.status}</td>
      `;

      scanTableBody.appendChild(tr);
    });

    progress_total.textContent = `/ ${outboundItems.length} í’ˆëª©`;
  }

  /* ------------------------------------------------------------
     ìŠ¤ìº” ì²˜ë¦¬
  ------------------------------------------------------------ */
  barcodeInput.addEventListener("keydown", e => {
    if (e.key === "Enter") {
      if (scanLocked) return; // âœ… ëª¨ë‹¬ í™•ì¸ ì „ ìŠ¤ìº” ê¸ˆì§€
      const code = barcodeInput.value.trim();
      barcodeInput.value = "";
      processScan(code);
    }
  });

  function processScan(code) {
    if (!code) return;

    const existed = scannedCodesSet.has(code);
    scannedCodesSet.add(code);

    const idx = outboundItems.findIndex(i => i.barcode === code);
    const item = idx >= 0 ? outboundItems[idx] : null;

    //  ë¯¸ë“±ë¡
    if (!item) {
      errorCountValue++;

      const meta = barcodeIndexByCode[code];
      let detail = `[ë¯¸ë“±ë¡] ${code}`;
      if (meta) detail += ` / ë°•ìŠ¤:${meta.box} / ${meta.name}`;
      else detail += ` / ë°”ì½”ë“œí‘œì—ë„ ì—†ìŒ`;

      recentScanStatus.textContent = "ë¯¸ë“±ë¡";
      recentScanDetail.textContent = detail;

      scanHistory.push({ code, type: "error", meta });
      playSound(soundError);

      openUnregModal(code, meta); //  ëª¨ë‹¬ + ì ê¸ˆ

      renderScanList();
      updateProgress();
      return;
    }

    // ì •ìƒ
    lastScannedBarcode = code;

    if (existed) {
      dupCountValue++;
      item.dup = true;

      scanHistory.push({ code, type: "dup", item });
      playSound(soundDup);
    } else {
      item.status = "ê²€ìˆ˜ì™„ë£Œ";
      item.dup = false;

      scanHistory.push({ code, type: "ok", item });
      playSound(soundOk);
    }

    renderOutboundTable();
    renderScanList();
    updateProgress();
  }

  /* ------------------------------------------------------------
     ìµœê·¼ 3ê±´ë§Œ í‘œì‹œ
  ------------------------------------------------------------ */
  function renderScanList() {
    if (scanHistory.length === 0) {
      scanList.innerHTML = `<div class="text-slate-400">ì•„ì§ ìŠ¤ìº” ì—†ìŒâ€¦</div>`;
      return;
    }

    const last3 = scanHistory.slice(-3).reverse();
    scanList.innerHTML = "";

    last3.forEach(entry => {
      const div = document.createElement("div");

      if (entry.type === "ok") {
        div.className = "text-green-700";
        div.textContent = `âœ… ${entry.code} (${entry.item.box}) - ${entry.item.name}`;
      } else if (entry.type === "dup") {
        div.className = "text-amber-700";
        div.textContent = `ğŸ” ${entry.code} (${entry.item.box}) - ${entry.item.name}`;
      } else {
        div.className = "text-red-600";
        if (entry.meta)
          div.textContent = `â›” ${entry.code} / ë°•ìŠ¤:${entry.meta.box} / ${entry.meta.name}`;
        else
          div.textContent = `â›” ${entry.code} (ë°”ì½”ë“œí‘œ ì—†ìŒ)`;
      }

      scanList.appendChild(div);
    });
  }

  /* ------------------------------------------------------------
     ì§„í–‰ë¥ 
  ------------------------------------------------------------ */
  function updateProgress() {
    const total = outboundItems.length;
    const completed = outboundItems.filter(it => it.status === "ê²€ìˆ˜ì™„ë£Œ").length;

    progress_now.textContent = completed;
    progress_total.textContent = `/ ${total} í’ˆëª©`;

    const percent = total > 0 ? Math.round((completed / total) * 100) : 0;

    progress_percent.textContent = percent + "%";
    progress_bar.style.width = percent + "%";

    error_count.textContent = errorCountValue;
    dup_count.textContent = dupCountValue;
  }

  /* ------------------------------------------------------------
     ì´ˆê¸°í™”
  ------------------------------------------------------------ */
  function resetUI() {
    inv_no.textContent = "-";
    country.textContent = "-";
    containerEl.textContent = "-";
    cbm.textContent = "-";
    qty.textContent = "-";
    load_time.textContent = "-";
    load_loc.textContent = "-";

    outboundItems = [];
    scanHistory = [];
    scannedCodesSet = new Set();
    dupCountValue = 0;
    errorCountValue = 0;
    lastScannedBarcode = null;

    scanTableBody.innerHTML = "";
    scanList.innerHTML = `<div class="text-slate-400">ì•„ì§ ìŠ¤ìº” ì—†ìŒâ€¦</div>`;

    progress_now.textContent = "0";
    progress_total.textContent = "/ 0 í’ˆëª©";
    progress_percent.textContent = "0%";
    progress_bar.style.width = "0%";

    error_count.textContent = "0";
    dup_count.textContent = "0";

    recentScanStatus.textContent = "-";
    recentScanDetail.textContent = "";

    // ëª¨ë‹¬ ë‹«ê¸°/ì ê¸ˆ í•´ì œ
    if (unregModal) unregModal.classList.add("hidden");
    setScanLocked(false);
  }

  /* ------------------------------------------------------------
     ì´ˆê¸° ì‹¤í–‰
  ------------------------------------------------------------ */
  if (!IS_FILE) loadBarcodeTable();

  noticeCloseBtn.addEventListener("click", () => {
    noticeModal.classList.add("hidden");
    barcodeInput.focus();
  });

  btnNoticeOpen.addEventListener("click", () => {
    if (!currentNotice) return alert("íŠ¹ì´ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.");
    playSound(soundModal);
    noticeText.textContent = currentNotice;
    noticeModal.classList.remove("hidden");
  });

  </script>

  <!-- ì €ì¥(ìº¡ì²˜) ê¸°ëŠ¥ -->
  <script>
    document.getElementById("btnCapture").addEventListener("click", async () => {
      try {
        const target = document.getElementById("captureArea");
        if (!target) return alert("ìº¡ì²˜ ì˜ì—­(#captureArea)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        const inv =
          (document.getElementById("inv_no")?.textContent || "").trim() ||
          (document.getElementById("invInput")?.value || "NO_INV").trim();

        const safeInv = inv.replace(/[\\/:*?"<>|]/g, "_");

        const nowCnt = document.getElementById("progress_now")?.textContent?.trim();
        const totalCnt = document.getElementById("progress_total")?.textContent?.trim();
        const errCnt = document.getElementById("error_count")?.textContent?.trim();
        const dupCnt = document.getElementById("dup_count")?.textContent?.trim();

        const suffixParts = [];
        if (nowCnt && totalCnt) suffixParts.push(`${nowCnt}of${totalCnt}`);
        if (errCnt) suffixParts.push(`ERR${errCnt}`);
        if (dupCnt) suffixParts.push(`DUP${dupCnt}`);
        const suffix = suffixParts.length ? "_" + suffixParts.join("_") : "";

        const canvas = await html2canvas(target, {
          scale: 2,
          backgroundColor: "#eef1f5",
          useCORS: true,
          scrollX: 0,
          scrollY: -window.scrollY
        });

        const a = document.createElement("a");
        a.href = canvas.toDataURL("image/png");
        a.download = `${safeInv}${suffix}.png`;
        a.click();
      } catch (e) {
        console.error(e);
        alert("ì €ì¥ ì‹¤íŒ¨: " + (e?.message || e));
      }
    });
  </script>

</body>
</html>
