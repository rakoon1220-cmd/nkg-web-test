<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>창고별 재고조사 · 남경 검수시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <style>
    body { background:#eef1f5; }

    /* ✅ 화면용 컴팩트 테이블 */
    table.ui-table { border-collapse: separate; border-spacing: 0; width:100%; }
    table.ui-table th, table.ui-table td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.2;
      vertical-align: middle;
      white-space: nowrap;
    }
    table.ui-table thead th {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 2;
      font-weight: 700;
      color: #111827;
      border-bottom: 1px solid #d1d5db;
      text-align: center;
      cursor: pointer;
      user-select: none;
    }
    table.ui-table thead th:hover { background: #e5e7eb; }
    table.ui-table tbody tr:hover { background:#f8fafc; }

    td.name-cell { white-space: normal; min-width: 260px; }
    td.remark { min-width: 180px; white-space: normal; }
    td.remark[contenteditable="true"]:focus {
      outline: 2px solid #93c5fd;
      outline-offset: -2px;
      background: #f8fafc;
    }

    /* 정렬 아이콘 */
    .sort-icon {
      display:inline-block;
      font-size: 10px;
      margin-left: 6px;
      color:#64748b;
    }

    @media (max-width: 640px) {
      table.ui-table th, table.ui-table td { padding: 7px 8px; font-size: 11px; }
      td.name-cell { min-width: 220px; }
      td.remark { min-width: 160px; }
    }
  </style>
</head>

<body class="min-h-screen bg-slate-100">

  <!-- ✅ 공통 NAV -->
  <script src="/nav.js"></script>

  <main class="pt-16 pb-10">
    <div class="max-w-6xl mx-auto px-4">

      <!-- 상단 카드 -->
      <section class="mb-4">
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
          <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
            <div>
              <div class="text-xs text-slate-500">재고 조사</div>
              <h1 class="text-lg md:text-xl font-semibold text-slate-800">창고별 재고조회</h1>
              <div class="text-[12px] text-slate-500 mt-1">
                (상품코드&박스번호) + (로케이션) 조회 / 앞 2자리 입력도 전체 조회
              </div>
            </div>

            <div class="flex gap-2">
              <button id="exportBtn"
                class="px-3 py-2 rounded-xl text-sm bg-emerald-600 text-white hover:bg-emerald-700 active:scale-[0.99] transition">
                엑셀 출력
              </button>
              <button id="showAllBtn"
                class="px-3 py-2 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800 active:scale-[0.99] transition">
                전체보기
              </button>
            </div>
          </div>

          <div class="mt-2 flex items-center justify-between gap-2">
            <div id="statusText" class="text-xs text-slate-500">CSV 로딩 전</div>
            <div class="flex items-center gap-3">
              <div id="csvStatus" class="text-xs text-slate-500">CSV: 대기</div>
              <div id="countText" class="text-xs text-slate-500">0건</div>
            </div>
          </div>
        </div>
      </section>

      <!-- 검색 카드 -->
      <section class="mb-4">
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
          <div class="grid grid-cols-1 md:grid-cols-12 gap-3">

            <div class="md:col-span-6">
              <label class="block text-xs text-slate-500 mb-1">상품코드 & 박스번호 (한 칸)</label>
              <input id="keyInput" type="text"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-200"
                placeholder="예: 1105601 또는 A870 또는 1105601 A870" />
            </div>

            <div class="md:col-span-4">
              <label class="block text-xs text-slate-500 mb-1"> (인보이스/BO0101/EX01-101 등)</label>
              <input id="bInput" type="text"
                class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-200"
                placeholder="예: BO / EX / 123456" />
            </div>

            <div class="md:col-span-2 flex gap-2 items-end">
              <button id="searchBtn"
                class="flex-1 bg-sky-500 text-white rounded-xl px-4 py-2 text-sm font-semibold shadow-sm hover:bg-sky-600 active:scale-[0.99] transition">
                조회
              </button>
              <button id="clearBtn"
                class="px-4 py-2 rounded-xl border border-slate-200 text-sm text-slate-700 hover:bg-slate-50 active:scale-[0.99] transition">
                초기화
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- 창고 버튼 -->
      <section class="mb-4">
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
          <div class="flex flex-wrap gap-2">
            <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="EX">EX창고</button>
            <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="GA">GA창고</button>
            <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="BO">BO창고</button>
            <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="SSS">SSS창고</button>
            <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="파손">파손</button>
            <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="CBM">CBM초과</button>
          </div>
          <div class="mt-2 text-[12px] text-slate-500">버튼은  <span class="font-semibold">포함(contains)</span> 기준</div>
        </div>
      </section>

      <!-- 테이블 -->
      <section>
        <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
          <div class="overflow-auto">
            <table class="ui-table" id="resultTable">
              <thead>
                <tr>
                  <th data-sort="LOC">로케이션<span class="sort-icon" id="sort_LOC"></span></th>
                  <th data-sort="PROD">상품<span class="sort-icon" id="sort_PROD"></span></th>
                  <th data-sort="BOX">박스<span class="sort-icon" id="sort_BOX"></span></th>
                  <th data-sort="NAME">상품명<span class="sort-icon" id="sort_NAME"></span></th>
                  <th data-sort="QTY">재고<span class="sort-icon" id="sort_QTY"></span></th>
                  <th data-sort="EXP">유통기한<span class="sort-icon" id="sort_EXP"></span></th>
                  <th data-sort="">비고</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="7" style="padding:14px; color:#6b7280;">데이터 로딩 중…</td></tr>
              </tbody>
            </table>
          </div>

          <div class="px-4 py-3 border-t border-slate-100 text-[11px] text-slate-500">
            헤더를 클릭하면 정렬됩니다(오름/내림). 엑셀 출력은 인쇄용(A4) 형식으로 저장됩니다.
          </div>
        </div>
      </section>

    </div>
  </main>

<script>
const CSV_URL_RAW =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmUNAeyndXfdxHjR-1CakW_Tm3OzmMTng5RkB53umXwucqpxABqMMcB0y8H5cHNg7aoHYqFztz0F/pub?gid=162849112&single=true&output=csv";

// ✅ 프록시로 가져오기 (_csv.js 사용)
const API_BASE = window.location.origin;
const CSV_URL = `${API_BASE}/api/_csv?url=${encodeURIComponent(CSV_URL_RAW)}`;

// ✅ CSV 열 인덱스(0부터)
const COL = {
  LOC: 1,    // 로케이션(B열)
  PROD: 2,
  BOX: 3,
  NAME: 4,
  QTY: 5,    // 재고
  EXP: 6     // 유통기한
};

let ALL_ROWS = [];
let CURRENT_ROWS = [];          // 현재 화면에 표시 중인 rows
const ROW_REMARKS = new Map();  // rowKey -> remark 텍스트 저장 (정렬/재렌더에도 유지)

let sortState = { key: "LOC", dir: "asc" }; // 기본 정렬 상태

const $ = (id) => document.getElementById(id);
function setCsvStatus(msg){ $("csvStatus").textContent = "CSV: " + msg; }
function setCount(n){ $("countText").textContent = n.toLocaleString() + "건"; }
function setStatus(msg, tone="base"){
  const el = $("statusText");
  el.textContent = msg;
  el.className = "text-xs " + (tone==="ok"?"text-emerald-600":tone==="err"?"text-rose-600":"text-slate-500");
}
function asText(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
function upper(v){ return asText(v).toUpperCase(); }
function normalizeQty(v){ return asText(v).replace(/,/g,"").trim(); }

function parseCsv(text){
  const rows = [];
  let row = [], field = "", inQuotes = false;
  for (let i=0; i<text.length; i++){
    const ch = text[i];
    if (ch === '"'){
      if (inQuotes && text[i+1] === '"'){ field+='"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes){ row.push(field); field=""; continue; }
    if ((ch === "\n" || ch === "\r") && !inQuotes){
      if (ch === "\r" && text[i+1] === "\n") i++;
      row.push(field); field="";
      if (row.some(c => asText(c) !== "")) rows.push(row);
      row = [];
      continue;
    }
    field += ch;
  }
  row.push(field);
  if (row.some(c => asText(c) !== "")) rows.push(row);
  return rows;
}

async function loadCsv(){
  setCsvStatus("로딩중…");
  setStatus("CSV 불러오는 중…");
  $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">데이터 로딩 중…</td></tr>`;
  setCount(0);

  try{
    const res = await fetch(CSV_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const rows = parseCsv(text);
    if(!rows || rows.length < 2) throw new Error("CSV 데이터가 비어있음");

    ALL_ROWS = rows.slice(1);
    setCsvStatus("완료 (" + ALL_ROWS.length.toLocaleString() + "행)");
    setStatus("CSV 로딩 완료", "ok");

    CURRENT_ROWS = ALL_ROWS.slice();
    sortState = { key: "LOC", dir: "asc" };
    sortAndRender();
  }catch(err){
    console.error(err);
    setCsvStatus("오류");
    setStatus("CSV 로딩 실패: " + err.message, "err");
    $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#dc2626;">CSV 로딩 실패: ${err.message}</td></tr>`;
  }
}

function splitKeyInput(raw){
  const s = asText(raw);
  if(!s) return [];
  return s.split(/[ \t&,/|]+/g).map(x=>x.trim()).filter(Boolean);
}

function captureRemarks(){
  const trs = Array.from(document.querySelectorAll("#tbody tr"));
  trs.forEach(tr=>{
    const tds = tr.querySelectorAll("td");
    if(tds.length !== 7) return;
    const loc = tds[0].innerText.trim();
    const prod = tds[1].innerText.trim();
    const box = tds[2].innerText.trim();
    const exp = tds[5].innerText.trim();
    const qty = tds[4].innerText.trim();
    const key = [loc, prod, box, exp, qty.replace(/,/g,"")].join("|");
    ROW_REMARKS.set(key, tds[6].innerText.trim());
  });
}

function renderRows(rows){
  setCount(rows.length);

  if(!rows.length){
    $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">결과 없음</td></tr>`;
    return;
  }

  const limit = 8000;
  const show = rows.length > limit ? rows.slice(0, limit) : rows;

  $("tbody").innerHTML = show.map(r=>{
    const loc  = asText(r[COL.LOC])  || "-";
    const prod = asText(r[COL.PROD]) || "-";
    const box  = asText(r[COL.BOX])  || "-";
    const name = asText(r[COL.NAME]) || "-";
    const qty  = normalizeQty(r[COL.QTY]) || "-";
    const exp  = asText(r[COL.EXP])  || "-";

    const key = [loc, prod, box, exp, qty].join("|");
    const remark = ROW_REMARKS.get(key) || "";

    return `
      <tr>
        <td style="text-align:center;">${loc}</td>
        <td style="text-align:center;">${prod}</td>
        <td style="text-align:center;">${box}</td>
        <td class="name-cell">${name}</td>
        <td style="text-align:right;">${qty}</td>
        <td style="text-align:center;">${exp}</td>
        <td class="remark" contenteditable="true" data-rowkey="${key}">${remark}</td>
      </tr>
    `;
  }).join("");

  document.querySelectorAll('td.remark[contenteditable="true"]').forEach(td=>{
    td.addEventListener("input", (e)=>{
      const k = e.target.getAttribute("data-rowkey");
      ROW_REMARKS.set(k, e.target.innerText.trim());
    });
  });

  if(rows.length > limit) setStatus(`결과 ${rows.length.toLocaleString()}건 (표시는 ${limit.toLocaleString()}건까지)`, "base");
  else setStatus(`결과 ${rows.length.toLocaleString()}건`, "ok");
}

function getSortValue(r, key){
  if(key === "LOC") return upper(r[COL.LOC]);
  if(key === "PROD") return upper(r[COL.PROD]);
  if(key === "BOX") return upper(r[COL.BOX]);
  if(key === "NAME") return upper(r[COL.NAME]);
  if(key === "EXP") return upper(r[COL.EXP]);
  if(key === "QTY"){
    const n = parseFloat(normalizeQty(r[COL.QTY]) || "0");
    return Number.isFinite(n) ? n : 0;
  }
  return "";
}

function sortRows(rows, key, dir){
  const mult = (dir === "asc") ? 1 : -1;
  rows.sort((a,b)=>{
    const va = getSortValue(a, key);
    const vb = getSortValue(b, key);
    if(typeof va === "number" && typeof vb === "number") return (va - vb) * mult;
    return String(va).localeCompare(String(vb), "ko") * mult;
  });
}

function updateSortIcons(){
  ["LOC","PROD","BOX","NAME","QTY","EXP"].forEach(k=>{
    const el = document.getElementById("sort_"+k);
    if(!el) return;
    if(sortState.key !== k) el.textContent = "";
    else el.textContent = (sortState.dir === "asc") ? "▲" : "▼";
  });
}

function sortAndRender(){
  captureRemarks();
  const rows = CURRENT_ROWS.slice();
  sortRows(rows, sortState.key, sortState.dir);
  updateSortIcons();
  renderRows(rows);
  CURRENT_ROWS = rows;
}

function applySearch(){
  const tokens = splitKeyInput($("keyInput").value);
  const bKey = upper($("bInput").value);

  let prodKey = "", boxKey = "";
  if(tokens.length === 1){
    const t = upper(tokens[0]);
    if(/^\d+$/.test(t)) prodKey = t;
    else boxKey = t;
  }else if(tokens.length >= 2){
    prodKey = upper(tokens[0]);
    boxKey  = upper(tokens[1]);
  }

  CURRENT_ROWS = ALL_ROWS.filter(r=>{
    const rLoc = upper(r[COL.LOC]);
    const rP   = upper(r[COL.PROD]);
    const rBox = upper(r[COL.BOX]);

    if(bKey && !rLoc.startsWith(bKey)) return false;
    if(prodKey && rP !== prodKey) return false;
    if(boxKey && !rBox.includes(boxKey)) return false;
    return true;
  });

  sortAndRender();
}

function filterByWarehouse(k){
  const key = upper(k);
  CURRENT_ROWS = ALL_ROWS.filter(r => upper(r[COL.LOC]).includes(key));
  sortAndRender();
}

function clearAll(){
  $("keyInput").value = "";
  $("bInput").value = "";
  CURRENT_ROWS = ALL_ROWS.slice();
  sortState = { key: "LOC", dir: "asc" };
  sortAndRender();
}

function exportToXlsx(){
  const trs = Array.from(document.querySelectorAll("#resultTable tbody tr"));
  if(!trs.length || (trs.length===1 && trs[0].innerText.includes("결과 없음"))){
    alert("내보낼 데이터가 없습니다.");
    return;
  }

  // ✅ 한국 기준 오늘 날짜
  const nowKST = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  const y = nowKST.getFullYear();
  const m = String(nowKST.getMonth()+1).padStart(2,"0");
  const d = String(nowKST.getDate()).padStart(2,"0");
  const dateText = `${y}-${m}-${d}`;

  const data = [];

  // =========================================================
  // ✅ 상단 3행 레이아웃
  // 1행: A~D(병합) = "재고조사 YYYY-MM-DD"
  //     E~F(병합) = "담당자"
  //     G = "확인"
  // 2~3행: 담당자/확인 서명칸
  // 4행: 테이블 헤더
  // =========================================================

  // Row1 (A1~G1)
  data.push([`재고조사 ${dateText}`, "", "", "", "담당자", "", "확인"]);
  // Row2 (A2~G2)
  data.push(["", "", "", "", "", "", ""]);
  // Row3 (A3~G3)
  data.push(["", "", "", "", "", "", ""]);

  // Row4: 테이블 헤더
  data.push(["로케이션","상품","박스","상품명","재고","유통기한","비고"]);

  // 데이터 (Row5~)
  trs.forEach(tr=>{
    const tds = Array.from(tr.querySelectorAll("td"));
    if(tds.length !== 7) return;
    data.push([
      tds[0].innerText.trim(),
      tds[1].innerText.trim(),
      tds[2].innerText.trim(),
      tds[3].innerText.trim(),
      tds[4].innerText.trim(),
      tds[5].innerText.trim(),
      tds[6].innerText.trim(),
    ]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);

  // ===== ✅ 병합(최종 요구사항) =====
  ws["!merges"] = [
    { s:{r:0,c:0}, e:{r:2,c:3} }, // A1:D3
    { s:{r:0,c:4}, e:{r:0,c:5} }, // E1:F1 (담당자)
    { s:{r:1,c:4}, e:{r:2,c:5} }, // ✅ E2:F3 (담당자 서명칸)
    { s:{r:1,c:6}, e:{r:2,c:6} }, // G2:G3 (확인 서명칸)
  ];

  // ===== ✅ 인쇄용 A4 (가로 + 너비 1페이지) =====
  ws["!pageSetup"] = {
    paperSize: 9,          // A4
    orientation: "landscape",
    fitToWidth: 1,
    fitToHeight: 0,
    scale: 100
  };
  ws["!margins"] = {
    left: 0.3, right: 0.3,
    top: 0.35, bottom: 0.35,
    header: 0.2, footer: 0.2
  };

  // ✅ 테이블 헤더가 4행이므로 반복행 = 4:4
  ws["!printTitleRows"] = "4:4";

  // ===== 컬럼폭 =====
  ws["!cols"] = [
    { wch: 12 }, // 로케이션
    { wch: 10 }, // 상품
    { wch: 10 }, // 박스
    { wch: 48 }, // 상품명
    { wch: 8  }, // 재고
    { wch: 12 }, // 유통기한
    { wch: 22 }  // 비고
  ];

  // ===== 행 높이(상단/서명칸 크게) =====
  ws["!rows"] = data.map((_, idx) => {
    if (idx === 0) return { hpt: 22 }; // 1행
    if (idx === 1) return { hpt: 26 }; // 2행
    if (idx === 2) return { hpt: 34 }; // 3행
    if (idx === 3) return { hpt: 22 }; // 헤더
    return { hpt: 18 };                // 데이터
  });

  // ===== 스타일 =====
  const border = {
    top:{style:"thin",color:{rgb:"000000"}},
    bottom:{style:"thin",color:{rgb:"000000"}},
    left:{style:"thin",color:{rgb:"000000"}},
    right:{style:"thin",color:{rgb:"000000"}},
  };

  const titleStyle = {
    font:{name:"맑은 고딕",sz:16,bold:true},
    alignment:{horizontal:"center",vertical:"center"},
    border
  };

  const signHeadStyle = {
    font:{name:"맑은 고딕",sz:11,bold:true},
    alignment:{horizontal:"center",vertical:"center"},
    border
  };

  const signBoxStyle = {
    alignment:{horizontal:"center",vertical:"center"},
    border
  };

  const headerStyle = {
    font:{name:"맑은 고딕",sz:12,bold:true},
    alignment:{horizontal:"center",vertical:"center"},
    fill:{fgColor:{rgb:"C9C9C9"}},
    border
  };

  const center = { font:{name:"맑은 고딕",sz:12}, alignment:{horizontal:"center",vertical:"center"}, border };
  const left   = { font:{name:"맑은 고딕",sz:12}, alignment:{horizontal:"left",vertical:"center",wrapText:true}, border };
  const right  = { font:{name:"맑은 고딕",sz:12}, alignment:{horizontal:"right",vertical:"center"}, border };

  // ===== 스타일 적용 =====
  const range = XLSX.utils.decode_range(ws["!ref"]);

  for(let R=0; R<=range.e.r; R++){
    for(let C=0; C<=range.e.c; C++){
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      if(!ws[addr]) continue;

      // A1:D3 영역(0~2행, 0~3열)
      if(R <= 2 && C <= 3){
        ws[addr].s = titleStyle;
        continue;
      }

      // E1:F1 담당자 타이틀
      if(R === 0 && (C === 4 || C === 5)){
        ws[addr].s = signHeadStyle;
        continue;
      }

      // G1 확인 타이틀
      if(R === 0 && C === 6){
        ws[addr].s = signHeadStyle;
        continue;
      }

      // ✅ E2:F3 담당자 서명칸 (세로 2줄)
      if((R === 1 || R === 2) && (C === 4 || C === 5)){
        ws[addr].s = signBoxStyle;
        continue;
      }

      // G2:G3 확인 서명칸
      if((R === 1 || R === 2) && C === 6){
        ws[addr].s = signBoxStyle;
        continue;
      }

      // 테이블 헤더(4행 = idx 3)
      if(R === 3){
        ws[addr].s = headerStyle;
        continue;
      }

      // 데이터(5행부터)
      if(R > 3){
        if(C===3 || C===6) ws[addr].s = left;
        else if(C===4) ws[addr].s = right;
        else ws[addr].s = center;
      }
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, "재고조회");
  XLSX.writeFile(wb, `창고별재고_${y}${m}${d}.xlsx`);
}





document.addEventListener("DOMContentLoaded", ()=>{
  $("searchBtn").addEventListener("click", applySearch);
  $("clearBtn").addEventListener("click", clearAll);
  $("showAllBtn").addEventListener("click", ()=>{
    CURRENT_ROWS = ALL_ROWS.slice();
    sortAndRender();
  });
  $("exportBtn").addEventListener("click", exportToXlsx);

  document.querySelectorAll(".whBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>filterByWarehouse(btn.dataset.key));
  });

  ["keyInput","bInput"].forEach(id=>{
    $(id).addEventListener("keydown",(e)=>{ if(e.key==="Enter") applySearch(); });
  });

  document.querySelectorAll("th[data-sort]").forEach(th=>{
    const key = th.dataset.sort;
    if(!key) return;
    th.addEventListener("click", ()=>{
      if(sortState.key === key) sortState.dir = (sortState.dir === "asc") ? "desc" : "asc";
      else { sortState.key = key; sortState.dir = "asc"; }
      sortAndRender();
    });
  });

  loadCsv();
});
</script>

</body>
</html>
