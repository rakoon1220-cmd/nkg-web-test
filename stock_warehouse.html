<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>창고별 재고조사 · 남경 검수시스템</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ✅ 엑셀 출력용 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>

  <style>
    body { background:#eef1f5; }

    /* ✅ 화면용: “컴팩트” 테이블 (모바일 덜 불편) */
    table.ui-table { border-collapse: separate; border-spacing: 0; width:100%; }
    table.ui-table th, table.ui-table td {
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 10px;
      font-size: 12px;
      line-height: 1.2;
      vertical-align: middle;
      white-space: nowrap;
    }
    table.ui-table thead th {
      position: sticky;
      top: 0;
      background: #f3f4f6;
      z-index: 2;
      font-weight: 700;
      color: #111827;
      border-bottom: 1px solid #d1d5db;
      text-align: center;
    }
    table.ui-table tbody tr:hover { background:#f8fafc; }

    /* 상품명은 줄바꿈 허용(모바일에서 특히) */
    td.name-cell {
      white-space: normal;
      min-width: 260px;
    }

    /* 비고: 화면에서 입력 */
    td.remark {
      min-width: 180px;
      white-space: normal;
    }
    td.remark[contenteditable="true"]:focus {
      outline: 2px solid #93c5fd;
      outline-offset: -2px;
      background: #f8fafc;
    }

    /* 모바일에선 더 컴팩트 */
    @media (max-width: 640px) {
      table.ui-table th, table.ui-table td { padding: 7px 8px; font-size: 11px; }
      td.name-cell { min-width: 220px; }
      td.remark { min-width: 160px; }
    }
  </style>
</head>

<body class="min-h-screen bg-slate-100">

<nav class="bg-[#0A1833] text-white fixed top-0 w-full z-50 shadow">
  <div class="max-w-6xl mx-auto px-4">
    <div class="flex justify-between items-center h-14">
      <a href="/index.html" class="flex items-center gap-2">
        <div class="w-8 h-8 bg-sky-500 rounded-lg flex items-center justify-center text-xs font-bold">NK</div>
        <span class="font-semibold text-sm tracking-wide">남경 검수시스템</span>
      </a>

      <div class="flex items-center gap-2 text-xs text-white/80">
        <span id="csvStatus" class="hidden sm:inline">CSV: 대기</span>
        <button id="reloadBtn"
          class="px-3 py-1.5 rounded-lg bg-white/10 hover:bg-white/15 active:scale-[0.99] transition">
          새로고침
        </button>
      </div>
    </div>
  </div>
</nav>

<main class="pt-16 pb-10">
  <div class="max-w-6xl mx-auto px-4">

    <!-- 상단 카드(예전 스타일 느낌 유지 + 컴팩트) -->
    <section class="mb-4">
      <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
          <div>
            <div class="text-xs text-slate-500">재고 조사</div>
            <h1 class="text-lg md:text-xl font-semibold text-slate-800">창고별 재고조회</h1>
            <div class="text-[12px] text-slate-500 mt-1">
              (상품코드&박스번호) + (B열 값) 조회 / 앞 2자리 입력도 전체 조회
            </div>
          </div>

          <div class="flex gap-2">
            <button id="exportBtn"
              class="px-3 py-2 rounded-xl text-sm bg-emerald-600 text-white hover:bg-emerald-700 active:scale-[0.99] transition">
              엑셀 출력
            </button>
            <button id="showAllBtn"
              class="px-3 py-2 rounded-xl text-sm bg-slate-900 text-white hover:bg-slate-800 active:scale-[0.99] transition">
              전체보기
            </button>
          </div>
        </div>

        <div class="mt-2 flex items-center justify-between gap-2">
          <div id="statusText" class="text-xs text-slate-500">CSV 로딩 전</div>
          <div id="countText" class="text-xs text-slate-500">0건</div>
        </div>
      </div>
    </section>

    <!-- 검색 카드 -->
    <section class="mb-4">
      <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3">

          <div class="md:col-span-6">
            <label class="block text-xs text-slate-500 mb-1">상품코드 & 박스번호 (한 칸)</label>
            <input id="keyInput" type="text"
              class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-200"
              placeholder="예: 1105601 또는 A870 또는 1105601 A870" />
          </div>

          <div class="md:col-span-4">
            <label class="block text-xs text-slate-500 mb-1">B열 값 (인보이스/BO0101/EX01-101 등)</label>
            <input id="bInput" type="text"
              class="w-full rounded-xl border border-slate-200 px-3 py-2 text-sm outline-none focus:ring-2 focus:ring-sky-200"
              placeholder="예: BO / EX / 123456" />
          </div>

          <div class="md:col-span-2 flex gap-2 items-end">
            <button id="searchBtn"
              class="flex-1 bg-sky-500 text-white rounded-xl px-4 py-2 text-sm font-semibold shadow-sm hover:bg-sky-600 active:scale-[0.99] transition">
              조회
            </button>
            <button id="clearBtn"
              class="px-4 py-2 rounded-xl border border-slate-200 text-sm text-slate-700 hover:bg-slate-50 active:scale-[0.99] transition">
              초기화
            </button>
          </div>
        </div>
      </div>
    </section>

    <!-- 창고 버튼 -->
    <section class="mb-4">
      <div class="bg-white rounded-2xl border border-slate-100 shadow-sm p-4">
        <div class="flex flex-wrap gap-2">
          <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="EX">EX창고</button>
          <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="GA">GA창고</button>
          <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="BO">BO창고</button>
          <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="SSS">SSS창고</button>
          <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="파손">파손</button>
          <button class="whBtn px-3 py-2 rounded-xl text-sm border border-slate-200 hover:bg-slate-50 transition" data-key="CBM">CBM초과</button>
        </div>
        <div class="mt-2 text-[12px] text-slate-500">
          버튼은 B열 <span class="font-semibold">포함(contains)</span> 기준
        </div>
      </div>
    </section>

    <!-- 테이블 -->
    <section>
      <div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden">
        <div class="overflow-auto">
          <table class="ui-table" id="resultTable">
            <thead>
              <tr>
                <th style="min-width:90px;">로케이션</th>
                <th style="min-width:90px;">상품</th>
                <th style="min-width:80px;">박스</th>
                <th style="min-width:320px;">상품명</th>
                <th style="min-width:100px;">유통기한</th>
                <th style="min-width:70px;">재고</th>
                <th style="min-width:180px;">비고</th>
              </tr>
            </thead>
            <tbody id="tbody">
              <tr>
                <td colspan="7" style="padding:14px; color:#6b7280;">데이터 로딩 중…</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="px-4 py-3 border-t border-slate-100 text-[11px] text-slate-500">
          엑셀 출력은 스샷형 간격(컬럼폭/행높이/폰트/여백)으로 강제됩니다.
        </div>
      </div>
    </section>

  </div>
</main>

<script>
/* ===============================
   CSV 로딩 (직접 or 프록시)
================================ */

// 원본 CSV
const CSV_URL_RAW =
  "https://docs.google.com/spreadsheets/d/e/2PACX-1vRAWmUNAeyndXfdxHjR-1CakW_Tm3OzmMTng5RkB53umXwucqpxABqMMcB0y8H5cHNg7aoHYqFztz0F/pub?gid=162849112&single=true&output=csv";

// ✅ 1) 직접 로딩(대부분 OK)
// const CSV_URL = CSV_URL_RAW;

// ✅ 2) 프록시 로딩(FAILED TO FETCH 뜨면 이걸로 바꿔)
// /api/csv.js 추가 필요
const API_BASE = window.location.origin;
const CSV_URL = `${API_BASE}/api/csv?url=${encodeURIComponent(CSV_URL_RAW)}`;

// ✅ 열 매핑(네 CSV에 맞춰 조정)
const COL = {
  A_LOC: 0,   // 로케이션
  B_TAG: 1,   // B열 값(인보이스/BO0101/EX01-101 등)
  C_PROD: 2,  // 상품코드
  D_BOX:  3,  // 박스번호
  E_NAME: 4,  // 상품명
  F_EXP:  5,  // 유통기한
  G_QTY:  6   // 재고
};

let ALL_ROWS = [];
let CURRENT_ROWS = [];

const $ = (id) => document.getElementById(id);
function setCsvStatus(msg){ $("csvStatus").textContent = "CSV: " + msg; }
function setCount(n){ $("countText").textContent = n.toLocaleString() + "건"; }
function setStatus(msg, tone="base"){
  const el = $("statusText");
  el.textContent = msg;
  el.className = "text-xs " + (tone==="ok"?"text-emerald-600":tone==="err"?"text-rose-600":"text-slate-500");
}

function asText(v){ return (v===null||v===undefined) ? "" : String(v).trim(); }
function upper(v){ return asText(v).toUpperCase(); }
function normalizeQty(v){ return asText(v).replace(/,/g,""); }

function parseCsv(text){
  const rows = [];
  let row = [], field = "", inQuotes = false;

  for (let i=0; i<text.length; i++){
    const ch = text[i];
    if (ch === '"'){
      if (inQuotes && text[i+1] === '"'){ field+='"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if (ch === "," && !inQuotes){ row.push(field); field=""; continue; }
    if ((ch === "\n" || ch === "\r") && !inQuotes){
      if (ch === "\r" && text[i+1] === "\n") i++;
      row.push(field); field="";
      if (row.some(c => asText(c) !== "")) rows.push(row);
      row = [];
      continue;
    }
    field += ch;
  }
  row.push(field);
  if (row.some(c => asText(c) !== "")) rows.push(row);
  return rows;
}

async function loadCsv(){
  setCsvStatus("로딩중…");
  setStatus("CSV 불러오는 중…");
  $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">데이터 로딩 중…</td></tr>`;
  setCount(0);

  try{
    const res = await fetch(CSV_URL, { cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();
    const rows = parseCsv(text);
    if(!rows || rows.length < 2) throw new Error("CSV 데이터가 비어있음");

    ALL_ROWS = rows.slice(1);
    setCsvStatus("완료 (" + ALL_ROWS.length.toLocaleString() + "행)");
    setStatus("CSV 로딩 완료", "ok");

    renderRows(ALL_ROWS);
  }catch(err){
    console.error(err);
    setCsvStatus("오류");
    setStatus("CSV 로딩 실패: " + err.message, "err");
    $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#dc2626;">CSV 로딩 실패: ${err.message}</td></tr>`;
  }
}

function splitKeyInput(raw){
  const s = asText(raw);
  if(!s) return [];
  return s.split(/[ \t&,/|]+/g).map(x=>x.trim()).filter(Boolean);
}

function renderRows(rows){
  CURRENT_ROWS = rows;
  setCount(rows.length);

  if(!rows.length){
    $("tbody").innerHTML = `<tr><td colspan="7" style="padding:14px; color:#6b7280;">결과 없음</td></tr>`;
    return;
  }

  const limit = 8000;
  const show = rows.length > limit ? rows.slice(0, limit) : rows;

  const html = show.map(r=>{
    const loc  = asText(r[COL.A_LOC]) || asText(r[COL.B_TAG]) || "-";
    const prod = asText(r[COL.C_PROD]) || "-";
    const box  = asText(r[COL.D_BOX])  || "-";
    const name = asText(r[COL.E_NAME]) || "-";
    const exp  = asText(r[COL.F_EXP])  || "-";
    const qty  = normalizeQty(r[COL.G_QTY]) || "-";

    return `
      <tr>
        <td style="text-align:center;">${loc}</td>
        <td style="text-align:center;">${prod}</td>
        <td style="text-align:center;">${box}</td>
        <td class="name-cell">${name}</td>
        <td style="text-align:center;">${exp}</td>
        <td style="text-align:right;">${qty}</td>
        <td class="remark" contenteditable="true"></td>
      </tr>
    `;
  }).join("");

  $("tbody").innerHTML = html;

  if(rows.length > limit) setStatus(`결과 ${rows.length.toLocaleString()}건 (표시는 ${limit.toLocaleString()}건까지)`, "base");
  else setStatus(`결과 ${rows.length.toLocaleString()}건`, "ok");
}

function applySearch(){
  const tokens = splitKeyInput($("keyInput").value);
  const bKey = upper($("bInput").value);

  let prodKey = "", boxKey = "";
  if(tokens.length === 1){
    const t = upper(tokens[0]);
    if(/^\d+$/.test(t)) prodKey = t;
    else boxKey = t;
  }else if(tokens.length >= 2){
    prodKey = upper(tokens[0]);
    boxKey  = upper(tokens[1]);
  }

  const filtered = ALL_ROWS.filter(r=>{
    const rB = upper(r[COL.B_TAG]);
    const rP = upper(r[COL.C_PROD]);
    const rD = upper(r[COL.D_BOX]);

    // ✅ B열 값 입력: 앞 2자리만 입력해도 전부 조회 => startsWith
    if(bKey && !rB.startsWith(bKey)) return false;

    if(prodKey && rP !== prodKey) return false;
    if(boxKey  && rD !== boxKey)  return false;

    return true;
  });

  renderRows(filtered);
}

function filterByWarehouse(k){
  const key = upper(k);
  renderRows(ALL_ROWS.filter(r => upper(r[COL.B_TAG]).includes(key)));
}

function clearAll(){
  $("keyInput").value = "";
  $("bInput").value = "";
  renderRows(ALL_ROWS);
  setStatus("초기화 완료");
}

/* ===============================
   엑셀 출력: 스샷형 간격 강제
   - 여백 0.6
   - 행높이 40
   - 폰트 12
   - 컬럼폭: 스샷처럼 (상품명/비고 넓게)
================================ */
function exportToXlsx(){
  const table = $("resultTable");
  const trs = Array.from(table.querySelectorAll("tbody tr"));
  if(!trs.length || (trs.length===1 && trs[0].innerText.includes("결과 없음"))){
    alert("내보낼 데이터가 없습니다.");
    return;
  }

  const data = [];
  data.push(["로케이션","상품","상품명","박스","유통기한","재고","비고"]); // ✅ 스샷 헤더 순서

  trs.forEach(tr=>{
    const tds = Array.from(tr.querySelectorAll("td"));
    if(tds.length !== 7) return;

    data.push([
      tds[0].innerText.trim(), // 로케이션
      tds[1].innerText.trim(), // 상품(상품코드)
      tds[3].innerText.trim(), // 상품명
      tds[2].innerText.trim(), // 박스
      tds[4].innerText.trim(), // 유통기한
      tds[5].innerText.trim(), // 재고
      tds[6].innerText.trim(), // 비고
    ]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(data);

  // ✅ 스샷 느낌 컬럼폭(상품명/비고 넓게)
  ws["!cols"] = [
    { wch: 12 }, // 로케이션
    { wch: 10 }, // 상품
    { wch: 48 }, // 상품명
    { wch: 10 }, // 박스
    { wch: 12 }, // 유통기한
    { wch: 8  }, // 재고
    { wch: 22 }  // 비고
  ];

  // ✅ 행높이 40(요구)
  ws["!rows"] = data.map(()=>({ hpt: 40 }));

  // ✅ 여백 0.6(인치)
  ws["!margins"] = { left:0.6, right:0.6, top:0.6, bottom:0.6, header:0.3, footer:0.3 };
  ws["!pageSetup"] = { fitToWidth: 1, fitToHeight: 0 };

  const border = {
    top:{style:"thin",color:{rgb:"000000"}},
    bottom:{style:"thin",color:{rgb:"000000"}},
    left:{style:"thin",color:{rgb:"000000"}},
    right:{style:"thin",color:{rgb:"000000"}},
  };

  const headerStyle = {
    font:{name:"맑은 고딕",sz:12,bold:true},
    alignment:{horizontal:"center",vertical:"center"},
    fill:{fgColor:{rgb:"C9C9C9"}},
    border
  };

  const center = {
    font:{name:"맑은 고딕",sz:12},
    alignment:{horizontal:"center",vertical:"center"},
    border
  };

  const left = {
    font:{name:"맑은 고딕",sz:12},
    alignment:{horizontal:"left",vertical:"center",wrapText:true},
    border
  };

  const right = {
    font:{name:"맑은 고딕",sz:12},
    alignment:{horizontal:"right",vertical:"center"},
    border
  };

  const range = XLSX.utils.decode_range(ws["!ref"]);
  for(let R=range.s.r; R<=range.e.r; R++){
    for(let C=range.s.c; C<=range.e.c; C++){
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      if(!ws[addr]) continue;

      if(R===0){
        ws[addr].s = headerStyle;
      }else{
        // 상품명(2), 비고(6)는 left, 재고(5)는 right, 나머지 center
        if(C===2 || C===6) ws[addr].s = left;
        else if(C===5) ws[addr].s = right;
        else ws[addr].s = center;
      }
    }
  }

  XLSX.utils.book_append_sheet(wb, ws, "재고조회");
  const now = new Date();
  const y = now.getFullYear();
  const m = String(now.getMonth()+1).padStart(2,"0");
  const d = String(now.getDate()).padStart(2,"0");
  XLSX.writeFile(wb, `창고별재고_${y}${m}${d}.xlsx`);
}

/* 이벤트 */
document.addEventListener("DOMContentLoaded", ()=>{
  $("reloadBtn").addEventListener("click", loadCsv);
  $("searchBtn").addEventListener("click", applySearch);
  $("clearBtn").addEventListener("click", clearAll);
  $("showAllBtn").addEventListener("click", ()=>renderRows(ALL_ROWS));
  $("exportBtn").addEventListener("click", exportToXlsx);

  document.querySelectorAll(".whBtn").forEach(btn=>{
    btn.addEventListener("click", ()=>filterByWarehouse(btn.dataset.key));
  });

  ["keyInput","bInput"].forEach(id=>{
    $(id).addEventListener("keydown",(e)=>{ if(e.key==="Enter") applySearch(); });
  });

  loadCsv();
});
</script>

</body>
</html>
